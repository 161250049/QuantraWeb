{% load static %}
<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="{% static 'styles/container2.css' %}">
    <script type="text/javascript" src="{% static 'js/jquery.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/vue.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/vue-strap.js' %}"></script>
    <script type="text/javascript" src="{% static 'bootstrap/js/bootstrap3-typeahead.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'bootstrap/js/bootstrap-table.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/echarts.min.js' %}"></script>
        <script src="https://cdn.bootcss.com/js-sha256/0.5.0/sha256.min.js"></script>
    <script src="https://cdn.bootcss.com/js-cookie/latest/js.cookie.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-validate/1.16.0/jquery.validate.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-validate/1.16.0/additional-methods.min.js"></script>

    <title>Quantra</title>
</head>
{% verbatim %}
<body>
<header>
    <div>
        <a href="javascript:" onclick="app.views.load('home');">
            <img src="res/images/logo.png">
        </a>
    </div>
    <div>
        <input id="searchBox" type="text" placeholder="股票代码/名称/拼音首字母...">
    </div>
    <div>
        <ul id="nav">
            <li><a href="javascript:" v-bind:class="{ act: selected == 'home' }" v-on:click="navClick"
                   data-view="home">
                首页
            </a></li>
            <li><a href="javascript:" v-bind:class="{ act: selected == 'market' }" v-on:click="navClick"
                   data-view="market">
                市场
            </a></li>
            <li><a href="javascript:" v-bind:class="{ act: selected == 'stocklist' }" v-on:click="navClick"
                   data-view="stocklist">
                历史行情
            </a></li>
            <li><a href="javascript:" v-bind:class="{ act: selected == 'realtimelist' }" v-on:click="navClick"
                   data-view="realtimelist">
                实时行情 (Beta)
            </a></li>
            <li><a id="logIcon" href="javascript:" v-bind:class="{ act: selected == 'login' }" v-on:click="navClick"
                   data-view="login">
                登录
            </a></li>
        </ul>
    </div>
</header>
<div id="container">
    <div class="loading" v-if="loading > 0">
        <i class="mdi mdi-loading mdi-spin" style="font-size: 128px;"></i>
    </div>
    <div id="content" v-bind:class="{ hidden: loading > 0 }">
    </div>
</div>

<script type="text/javascript">
    // app container
    window.app = {
        nav: new Vue({
            el: '#nav',
            data: {
                selected: ''
            },
            methods: {
                navClick: function (e) {
                    app.views.load(e.target.dataset.view);
                }
            }
        }),

        loading: new Vue({
            el: '#container',
            data: {
                loading: 0
            },
            methods: {
                show: function () {
                    this.loading++;
                },
                hide: function () {
                    this.loading--;
                    if (this.loading < 0) this.loading = 0;
                }
            }
        }),

        views: {
            name: '',
            param: {},
            setParam: function (param, clear) {
                if (clear) {
                    this.param = param;
                } else if (param) {
                    for (var key in param) {
                        this.param[key] = param[key];
                    }
                }
                var hash = this.name;
                if (this.param) {
                    hash += '?' + $.param(this.param);
                } else {
                    this.param = {};
                }
                window.location.hash = hash;
            },
            load: function (name, param) {
                app.loading.show();
                this.name = name;
                this.setParam(param, true);
                app.nav.selected = name;
                $('#content').load('res/views/' + name + '.html?' + new Date().getTime(), function () {
                    app.loading.hide();
                });
            },
            searchBoxFocus: function (enable) {
                if (enable) {
                    $('body').on('keypress', function (e) {
                        $('#searchBox').focus();
                    });
                } else {
                    $('body').off('keypress');
                }
            }
        },

        requests: {
            ws: null,
            wsConnect: function (path) {
                if (app.requests.ws != null) {
                    app.requests.ws.close();
                }
                app.requests.ws = new WebSocket('ws://' + location.host + '/' + path);
            }
        },

        index: {
            min_date: '',
            max_date: '',
            stocks: {},
            fetch: function () {
                return $.getJSON('/api/stock/index').done(function (data) {
                    app.index.min_date = data.min;
                    app.index.max_date = data.max;
                    app.index.stocks = data.index;
                    var src = [];
                    for (var code in data.index) {
                        src.push(app.utils.formatCode(code) + ' ' + data.index[code].name + ' ' + data.index[code].pinyin);
                    }
                    $('#searchBox').typeahead({
                        source: src,
                        items: 10,
                        afterSelect: function (a) {
                            $('#searchBox').val('');
                            var code = Number(a.split(' ')[0]);
                            app.views.load('stock', {code: code});
                        }
                    });
                    app.views.searchBoxFocus(true);
                });
            }
        },

        utils: {
            formatCode: function (code) {
                var s = '00000' + code;
                return s.substr(s.length - 6);
            },

            formatPercent: function (pct) {
                return Math.round(pct * 10000) / 100 + '%';
            },

            ma: function (arr) {
                return arr.reduce(function (a, b) {
                        return a + b;
                    }) / arr.length;
            },

            ema: function (arr) {
                var alpha = 2 / (arr.length + 1), sum = 0;
                for (var i = 0; i < arr.length; i++) {
                    sum += Math.pow(alpha, i) * arr[i];
                }
                return alpha * sum;
            },

            std: function (arr) {
                var mean = this.ma(arr);
                return Math.sqrt(arr.map(function (a) {
                        return Math.pow(a - mean, 2)
                    })
                        .reduce(function (a, b) {
                            return a + b;
                        }) / arr.length);
            }
        }
    };

    $(function () {
        app.loading.show();
        app.index.fetch().always(function () {
            app.loading.hide();
            var hash = location.hash.substr(1).split('?');
            if (hash[0] != '') {
                var params = {};
                if (hash.length > 1) {
                    query = hash[1].split('&');
                    for (var i = query.length; i > 0;) {
                        var pair = query[--i].split('=');
                        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
                    }
                }
                app.views.load(hash[0], params);
            } else {
                app.views.load('home');
            }
        });
    });
</script>
</body>
{% endverbatim %}
</html>